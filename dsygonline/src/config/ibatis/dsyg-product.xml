<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap
        PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN"
        "http://www.ibatis.com/dtd/sql-map-2.dtd">
<sqlMap namespace="com.cn.dsyg">

	<resultMap id="ProductQuantityDto" class="com.cn.dsyg.dto.ProductDto">
		<result property="id" column="id" />
		<result property="belongto" column="belongto" />
		<result property="fieldno" column="fieldno" />
		<result property="brand" column="brand" />
		<result property="quantity" column="quantity" />
		<result property="basetaxprice" column="basetaxprice" />
		<result property="item1" column="item1" />
		<result property="item2" column="item2" />
		<result property="item3" column="item3" />
		<result property="tradename" column="tradename" />
		<result property="typeno" column="typeno" />
		<result property="color" column="color" />
		<result property="packaging" column="packaging" />
		<result property="unit" column="unit" />
		<result property="sampleflag" column="sampleflag" />
		<result property="productname" column="productname" />
		<result property="makearea" column="makearea" />
		<result property="supplierid" column="supplierid" />
		<result property="salesprice" column="salesprice" />
		<result property="purchaseprice" column="purchaseprice" />
		<result property="note" column="note" />
		<result property="item01" column="item01" />
		<result property="item02" column="item02" />
		<result property="item03" column="item03" />
		<result property="item04" column="item04" />
		<result property="item05" column="item05" />
		<result property="item06" column="item06" />
		<result property="item07" column="item07" />
		<result property="item08" column="item08" />
		<result property="item09" column="item09" />
		<result property="item10" column="item10" />
		<result property="item11" column="item11" />
		<result property="item12" column="item12" />
		<result property="item13" column="item13" />
		<result property="item14" column="item14" />
		<result property="item15" column="item15" />
		<result property="item16" column="item16" />
		<result property="item17" column="item17" />
		<result property="item18" column="item18" />
		<result property="item19" column="item19" />
		<result property="item20" column="item20" />
		<result property="item21" column="item21" />
		<result property="item22" column="item22" />
		<result property="item23" column="item23" />
		<result property="item24" column="item24" />
		<result property="item25" column="item25" />
		<result property="item26" column="item26" />
		<result property="item27" column="item27" />
		<result property="item28" column="item28" />
		<result property="item29" column="item29" />
		<result property="item30" column="item30" />
		<result property="pic01" column="pic01" />
		<result property="pic02" column="pic02" />
		<result property="pic03" column="pic03" />
		<result property="pic04" column="pic04" />
		<result property="pic05" column="pic05" />
		<result property="pdfpath" column="pdfpath" />
		<result property="rank" column="rank" />
		<result property="status" column="status" />
		<result property="res01" column="res01" />
		<result property="res02" column="res02" />
		<result property="res03" column="res03" />
		<result property="res04" column="res04" />
		<result property="res05" column="res05" />
		<result property="res06" column="res06" />
		<result property="res07" column="res07" />
		<result property="res08" column="res08" />
		<result property="res09" column="res09" />
		<result property="res10" column="res10" />
		<result property="keyword" column="keyword" />
		<result property="createuid" column="createuid" />
		<result property="createdate" column="createdate" />
		<result property="updateuid" column="updateuid" />
		<result property="updatedate" column="updatedate" />
	</resultMap>
	
	<resultMap id="ProductDto" class="com.cn.dsyg.dto.ProductDto">
		<result property="id" column="id" />
		<result property="belongto" column="belongto" />
		<result property="fieldno" column="fieldno" />
		<result property="brand" column="brand" />
		<result property="item1" column="item1" />
		<result property="item2" column="item2" />
		<result property="item3" column="item3" />
		<result property="tradename" column="tradename" />
		<result property="typeno" column="typeno" />
		<result property="color" column="color" />
		<result property="packaging" column="packaging" />
		<result property="unit" column="unit" />
		<result property="sampleflag" column="sampleflag" />
		<result property="productname" column="productname" />
		<result property="makearea" column="makearea" />
		<result property="supplierid" column="supplierid" />
		<result property="salesprice" column="salesprice" />
		<result property="purchaseprice" column="purchaseprice" />
		<result property="note" column="note" />
		<result property="item01" column="item01" />
		<result property="item02" column="item02" />
		<result property="item03" column="item03" />
		<result property="item04" column="item04" />
		<result property="item05" column="item05" />
		<result property="item06" column="item06" />
		<result property="item07" column="item07" />
		<result property="item08" column="item08" />
		<result property="item09" column="item09" />
		<result property="item10" column="item10" />
		<result property="item11" column="item11" />
		<result property="item12" column="item12" />
		<result property="item13" column="item13" />
		<result property="item14" column="item14" />
		<result property="item15" column="item15" />
		<result property="item16" column="item16" />
		<result property="item17" column="item17" />
		<result property="item18" column="item18" />
		<result property="item19" column="item19" />
		<result property="item20" column="item20" />
		<result property="item21" column="item21" />
		<result property="item22" column="item22" />
		<result property="item23" column="item23" />
		<result property="item24" column="item24" />
		<result property="item25" column="item25" />
		<result property="item26" column="item26" />
		<result property="item27" column="item27" />
		<result property="item28" column="item28" />
		<result property="item29" column="item29" />
		<result property="item30" column="item30" />
		<result property="pic01" column="pic01" />
		<result property="pic02" column="pic02" />
		<result property="pic03" column="pic03" />
		<result property="pic04" column="pic04" />
		<result property="pic05" column="pic05" />
		<result property="pdfpath" column="pdfpath" />
		<result property="rank" column="rank" />
		<result property="status" column="status" />
		<result property="res01" column="res01" />
		<result property="res02" column="res02" />
		<result property="res03" column="res03" />
		<result property="res04" column="res04" />
		<result property="res05" column="res05" />
		<result property="res06" column="res06" />
		<result property="res07" column="res07" />
		<result property="res08" column="res08" />
		<result property="res09" column="res09" />
		<result property="res10" column="res10" />
		<result property="keyword" column="keyword" />
		<result property="createuid" column="createuid" />
		<result property="createdate" column="createdate" />
		<result property="updateuid" column="updateuid" />
		<result property="updatedate" column="updatedate" />
	</resultMap>
	
	<select id="queryOnlineProductByPage" parameterClass="java.util.Map" resultMap="ProductQuantityDto">
		SELECT T.* FROM
		(	
			SELECT B.*,
			(
				SELECT A.quantity FROM
				(SELECT W.productid,SUM(W.quantity) AS quantity FROM etb_warehouse W WHERE 1 = 1 GROUP BY W.productid) A
				WHERE A.productid = B.id
			) AS quantity,
			(
				SELECT A.basetaxprice FROM
				(SELECT W.productid,SUM(W.taxamount)/SUM(W.quantity) AS basetaxprice FROM etb_warehouse W WHERE 1 = 1 and W.warehousetype = '1' GROUP BY W.productid) A
				WHERE A.productid = B.id
			) AS basetaxprice
			FROM etb_product B where B.rank <![CDATA[<=]]> 50
		) T WHERE 1 = 1
		<isNotEmpty prepend="and" property="keyword">
			T.keyword like '%$keyword$%' ESCAPE '/'
		</isNotEmpty>
		<isNotEmpty prepend="and" property="fieldno">
			T.fieldno = #fieldno#
		</isNotEmpty>
		<isNotEmpty prepend="and" property="stockfalg">
			T.quantity <![CDATA[>]]> 0
		</isNotEmpty>
		order by T.belongto,T.fieldno,T.tradename,T.typeno,T.color,T.item10,T.packaging,T.id asc
		LIMIT #start#, #end#
	</select>
	
	<select id="queryOnlineProductCountByPage" resultClass="int" parameterClass="java.util.Map">
		SELECT count(*) FROM
		(	
			SELECT B.*,
			(
				SELECT A.quantity FROM
				(SELECT W.productid,SUM(W.quantity) AS quantity FROM etb_warehouse W WHERE 1 = 1 GROUP BY W.productid) A
				WHERE A.productid = B.id
			) AS quantity,
			(
				SELECT A.basetaxprice FROM
				(SELECT W.productid,SUM(W.taxamount)/SUM(W.quantity) AS basetaxprice FROM etb_warehouse W WHERE 1 = 1 and W.warehousetype = '1' GROUP BY W.productid) A
				WHERE A.productid = B.id
			) AS basetaxprice
			FROM etb_product B where B.rank <![CDATA[<=]]> 50
		) T WHERE 1 = 1
		<isNotEmpty prepend="and" property="keyword">
			T.keyword like '%$keyword$%' ESCAPE '/'
		</isNotEmpty>
		<isNotEmpty prepend="and" property="fieldno">
			T.fieldno = #fieldno#
		</isNotEmpty>
		<isNotEmpty prepend="and" property="stockfalg">
			T.quantity > 0
		</isNotEmpty>
	</select>
	
	<select id="queryProductByID" parameterClass="java.util.Map" resultMap="ProductQuantityDto">
		SELECT * FROM
		(	
			SELECT B.*,
			(
				SELECT A.quantity FROM
				(SELECT W.productid,SUM(W.quantity) AS quantity FROM etb_warehouse W WHERE 1 = 1 GROUP BY W.productid) A
				WHERE A.productid = B.id
			) AS quantity,
			(
				SELECT A.basetaxprice FROM
				(SELECT W.productid,SUM(W.taxamount)/SUM(W.quantity) AS basetaxprice FROM etb_warehouse W WHERE 1 = 1 and W.warehousetype = '1' GROUP BY W.productid) A
				WHERE A.productid = B.id
			) AS basetaxprice
			FROM etb_product B where B.rank <![CDATA[<=]]> 50 and B.id = #id#
		) T where 1 = 1
	</select>
	
</sqlMap>